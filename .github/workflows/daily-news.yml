name: Daily News Auto Publisher

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 1:00 æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 9:00ï¼‰
    - cron: '0 1 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  publish-news:
    runs-on: ubuntu-latest
    steps:
    - name: Check Time
      run: |
        echo "ğŸ• æ‰§è¡Œæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ‡¨ğŸ‡³ åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        echo "ğŸ“° å¼€å§‹å‘å¸ƒæ¯æ—¥èµ„è®¯..."

    - name: Trigger Coze Workflow
      env:
        COZE_TOKEN: ${{ secrets.COZE_TOKEN }}
      run: |
        echo "ğŸ”§ é…ç½®ä¿¡æ¯:"
        echo "APIç«¯ç‚¹: https://api.coze.cn/v1/workflow/stream_run"
        echo "å·¥ä½œæµID: 7565827159563550756"
        echo "Tokené•¿åº¦: ${#COZE_TOKEN} å­—ç¬¦"
        
        echo "ğŸš€ å‘é€è¯·æ±‚åˆ°æ‰£å­å¹³å°..."
        
        # å‘é€APIè¯·æ±‚
        response=$(curl -s -w "HTTP_STATUS:%{http_code}" \
          -X POST "https://api.coze.cn/v1/workflow/stream_run" \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $COZE_TOKEN" \
          -d '{
            "workflow_id": "7565827159563550756",
            "parameters": {}
          }')
        
        # æå–çŠ¶æ€ç å’Œå“åº”ä½“
        http_status=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d':' -f2)
        response_body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*//')
        
        echo "ğŸ“Š å“åº”çŠ¶æ€ç : $http_status"
        echo "ğŸ“„ å“åº”å†…å®¹: $response_body"
        
        # åˆ¤æ–­ç»“æœ
        if [ "$http_status" -eq 200 ]; then
          echo "âœ… å·¥ä½œæµè§¦å‘æˆåŠŸï¼"
          echo "ğŸ’¬ è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ˜¯å¦æ”¶åˆ°æ¶ˆæ¯"
          exit 0
        else
          echo "âŒ å·¥ä½œæµè§¦å‘å¤±è´¥"
          echo "ğŸ” è¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½åŸå› ï¼š"
          echo "  1. Tokenæƒé™æ˜¯å¦æ­£ç¡®"
          echo "  2. å·¥ä½œæµIDæ˜¯å¦å­˜åœ¨"
          echo "  3. å·¥ä½œæµæ˜¯å¦å·²å‘å¸ƒ"
          exit 1
        fi

    - name: Success Notification
      if: success()
      run: |
        echo "ğŸ‰ æ¯æ—¥èµ„è®¯è‡ªåŠ¨å‘å¸ƒä»»åŠ¡å®Œæˆï¼"
        echo "âœ… GitHub Actions æ‰§è¡ŒæˆåŠŸ"
        echo "â° ä¸‹æ¬¡æ‰§è¡Œ: æ˜å¤© 09:00 (åŒ—äº¬æ—¶é—´)"
        echo "ğŸ“± è¯·æ£€æŸ¥ä¼å¾®ç¾¤æ¶ˆæ¯"

    - name: Failure Notification
      if: failure()
      run: |
        echo "âš ï¸ ä»»åŠ¡æ‰§è¡Œå¤±è´¥"
        echo "ğŸ’¡ å»ºè®®æ“ä½œï¼š"
        echo "  1. æ£€æŸ¥æ‰£å­å¹³å°Tokenæƒé™"
        echo "  2. ç¡®è®¤å·¥ä½œæµIDæ­£ç¡®"
        echo "  3. åœ¨æ‰£å­å¹³å°æ‰‹åŠ¨æµ‹è¯•å·¥ä½œæµ"
        echo "  4. æŸ¥çœ‹ä¸Šæ–¹è¯¦ç»†é”™è¯¯ä¿¡æ¯"
